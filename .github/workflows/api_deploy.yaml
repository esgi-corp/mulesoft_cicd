name: Deploy MuleSoft API

on:
  workflow_call:
    inputs:
      env:
        description: "Deployment environment"
        required: true
        type: string
      branch:
        description: "Branch to deploy"
        required: false
        type: string
      jira_ticket:
        description: "Jira ticket number"
        required: false
        type: string
      workers:
        description: "Number of replicas"
        required: false
        type: string
      vcores:
        description: "Number of vcores"
        required: false
        type: string
      app_name:
        description: "API name"
        required: false
        type: string
      repo_props_name:
        description: "Properties repository name"
        required: false
        type: string

jobs:
  deploy_api:
    runs-on: ubuntu-latest

    env:
      ANYPOINT_CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
      ANYPOINT_CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
      CONNECTEDAPP_CLIENT_ID: ${{ secrets.CONNECTEDAPP_CLIENT_ID }}
      CONNECTEDAPP_CLIENT_SECRET: ${{ secrets.CONNECTEDAPP_CLIENT_SECRET }}
      TARGET: ${{ secrets.TARGET }}
      GIT_ORG: ${{ secrets.GIT_ORG }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      APP_NAME: ${{ inputs.APP_NAME }}
      WORKERS: ${{ inputs.WORKERS }}
      VCORES: ${{ inputs.VCORES }}
      SANDBOX_MULE_KEY: ${{ secrets.SANDBOX_MULE_KEY}}
      PRD_MULE_KEY: ${{ secrets.PRD_MULE_KEY }}
      DEV_MULE_KEY: ${{ secrets.DEV_MULE_KEY }}
      ENV: ${{ inputs.ENV }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.BRANCH }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Checkout Properties repository
        uses: actions/checkout@v4
        with:
          repository: esgi-corp/${{ inputs.REPO_PROPS_NAME }}
          path: properties-repo
          token: ${{ secrets.PAT_TOKEN }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up vars API name
        run: |
          echo "API_NAME=${APP_NAME}-${ENV}" >> $GITHUB_ENV

      - name: Inject all properties into API package
        run: |
          echo "üì• Injecting ALL properties into API package"
          mkdir -p src/main/resources/props

          cp -v properties-repo/*-properties.yaml src/main/resources/props/ || true
          cp -v properties-repo/*-secure-properties.yaml src/main/resources/props/ || true

          # Nettoyer le r√©pertoire temporaire
          rm -rf properties-repo

      - name: Extract version from pom.xml
        id: extract_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>([^<]+)<\/version>.*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish asset to Github
        if: inputs.ENV == 'sandbox'
        run: |
          echo "üì¶ Publishing to Github..."
            mvn clean deploy --settings .maven/settings.xml -DskipTests \
              -DaltDeploymentRepository=github-mule-assets::default::https://maven.pkg.github.com/esgi-corp/mule-assets \
              -Dclient.id="$CONNECTEDAPP_CLIENT_ID" \
              -Dclient.secret="$CONNECTEDAPP_CLIENT_SECRET" \
              -Dgit.username=${GIT_ORG} \
              -Dpat.token=${PAT_TOKEN}

      - name: Publish asset to Exchange
        if: inputs.ENV == 'sandbox'
        run: |
          echo "üì¶ Publishing to Exchange..."
            mvn deploy --settings .maven/settings.xml -DskipTests \
              -Dclient.id="$CONNECTEDAPP_CLIENT_ID" \
              -Dclient.secret="$CONNECTEDAPP_CLIENT_SECRET" \
              -Dgit.username=${GIT_ORG} \
              -Dpat.token=${PAT_TOKEN}

      - name: Select mule key based on env deployment
        run: |
          if [ "${ENV}" = "prd" ]; then
            echo "MULE_KEY=${PRD_MULE_KEY}" >> $GITHUB_ENV
          elif [ "${ENV}" = "dev" ]; then
            echo "MULE_KEY=${DEV_MULE_KEY}" >> $GITHUB_ENV
          else
            echo "MULE_KEY=${SANDBOX_MULE_KEY}" >> $GITHUB_ENV
          fi

      - name: Deploy to CloudHub 2.0
        run: |
          mvn -U -B package mule:deploy --settings .maven/settings.xml \
            -Dapp.name=${API_NAME} \
            -Denv=${ENV} \
            -Dtarget=${TARGET} \
            -Dclient.id="${CONNECTEDAPP_CLIENT_ID}" \
            -Dclient.secret="${CONNECTEDAPP_CLIENT_SECRET}" \
            -DanypointClientId=${ANYPOINT_CLIENT_ID} \
            -DanypointClientSecret=${ANYPOINT_CLIENT_SECRET} \
            -Dmule.key=${MULE_KEY} \
            -Dworkers=${WORKERS} \
            -Dvirtual.cores=${VCORES}

      - name: Check deployment success
        if: steps.deploy.outcome == 'success'
        run: echo "‚úÖ Deployment succeeded."

      - name: Create and push tag
        if: inputs.env == 'sandbox'
        run: |
          TAG_NAME="${APP_NAME}-${VERSION}"

          echo "üîç Checking if tag $TAG_NAME already exists on remote..."

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "‚úÖ Tag $TAG_NAME already exists. Skipping tag creation."
          else
            echo "üè∑Ô∏è Creating and pushing tag $TAG_NAME..."
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi

      - name: Login to Jira Platform
        if: inputs.jira_ticket != '' && inputs.env != 'sandbox'
        uses: atlassian/gajira-login@master
        env:
            JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
            JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
            JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Send deployment info to Jira
        if: inputs.jira_ticket != '' && inputs.env != 'sandbox'
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ inputs.jira_ticket }}
          comment: |
            üöÄ Deployment of tag ${{ github.ref_name }} to ${{ inputs.env }} environment was successful.

      - name: Update branch main to deployed tag
        if: inputs.env == 'prd'
        run: |
          echo "üîÄ Updating branch main to tag ${{ github.ref_name }}..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # R√©cup√®re la branche main et le tag
          git fetch origin main --depth=1
          git fetch origin "refs/tags/${{ github.ref_name }}:refs/tags/${{ github.ref_name }}"

          # Bascule main sur le commit du tag
          git checkout main
          git reset --hard "${{ github.ref_name }}"

          # Met √† jour main c√¥t√© remote
          git push origin main --force
